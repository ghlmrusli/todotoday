<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook To-Do</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Handlee&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fuzzy+Bubbles&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            margin: 0;
            display: flex;
            min-height: 100dvh;
            perspective: 1000px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            color: hsl(180 68% 5%);
            background: #1a2332;
        }

        .book {
            position: relative;
            display: flex;
            margin: auto;
            width: 300px;
            height: 500px;
            pointer-events: none;
            transform-style: preserve-3d;
            transition: translate 1s, rotate 1s;
            translate: calc(min(var(--c), 1) * 50%) 0%;
            rotate: 1 0 0 calc(30deg * (1 - min(var(--c), 1)));
        }

        .page {
            --thickness: 4;
            flex: none;
            display: flex;
            width: 100%;
            height: 100%;
            font-size: 12px;
            pointer-events: all;
            user-select: none;
            transform-style: preserve-3d;
            transform-origin: left center;
            transition:
                transform 1s,
                rotate 1s ease-in calc((min(var(--i), var(--c)) - max(var(--i), var(--c))) * 50ms);
            translate: calc(var(--i) * -100%) 0px 0px;
            transform: translateZ(calc((var(--c) - var(--i) - 0.5) * calc(var(--thickness) * 0.69px)));
            rotate: 0 1 0 calc(clamp(0, var(--c) - var(--i), 1) * -180deg);
            box-shadow: 0em .5em 1em -.2em #00000020;
        }

        .front,
        .back {
            position: relative;
            flex: none;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            overflow: hidden;
            background-color: #fff;
            translate: 0px;
            display: flex;
            flex-flow: column;
            justify-content: flex-start;
            padding: 2em;
            border: 1px solid #0002;
        }

        .back {
            translate: -100% 0;
            rotate: 0 1 0 180deg;
        }

        .front {
            background: linear-gradient(to left, #f7f7f7 80%, #eee 100%);
            border-radius: .1em .5em .5em .1em;
        }

        .back {
            background-image: linear-gradient(to right, #f7f7f7 80%, #eee 100%);
            border-radius: .5em .1em .1em .5em;
        }

        /* Cover Page */
        .cover.front {
            background: linear-gradient(135deg, #4db8e8 0%, #3a9fd5 100%);
            background-image: 
                linear-gradient(135deg, #4db8e8 0%, #3a9fd5 100%),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(255,255,255,0.03) 2px,
                    rgba(255,255,255,0.03) 4px
                );
            color: #1a2332;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }

        .cover.front::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 15% 25%, rgba(0,0,0,0.08) 1px, transparent 1px),
                radial-gradient(circle at 85% 15%, rgba(0,0,0,0.06) 1px, transparent 1px),
                radial-gradient(circle at 45% 65%, rgba(0,0,0,0.07) 1px, transparent 1px),
                radial-gradient(circle at 70% 80%, rgba(0,0,0,0.06) 1px, transparent 1px),
                radial-gradient(circle at 25% 50%, rgba(0,0,0,0.05) 1px, transparent 1px),
                radial-gradient(circle at 90% 45%, rgba(0,0,0,0.08) 1px, transparent 1px),
                radial-gradient(circle at 10% 75%, rgba(0,0,0,0.06) 1px, transparent 1px),
                radial-gradient(circle at 60% 30%, rgba(0,0,0,0.07) 1px, transparent 1px),
                radial-gradient(circle at 35% 90%, rgba(0,0,0,0.05) 1px, transparent 1px),
                radial-gradient(circle at 80% 60%, rgba(0,0,0,0.08) 1px, transparent 1px);
            background-size: 
                120px 120px,
                150px 150px,
                100px 100px,
                130px 130px,
                110px 110px,
                140px 140px,
                90px 90px,
                160px 160px,
                125px 125px,
                105px 105px;
            background-position: 
                0 0,
                30px 20px,
                60px 50px,
                15px 70px,
                80px 10px,
                45px 85px,
                70px 35px,
                25px 60px,
                90px 75px,
                50px 40px;
            opacity: 1;
            pointer-events: none;
            mix-blend-mode: multiply;
        }

        .cover.back {
            background: linear-gradient(135deg, #e8f4f8 0%, #d5e9f0 100%);
            position: relative;
        }

        .cover.back::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 35%, rgba(0,0,0,0.08) 1px, transparent 1px),
                radial-gradient(circle at 75% 20%, rgba(0,0,0,0.06) 1px, transparent 1px),
                radial-gradient(circle at 50% 70%, rgba(0,0,0,0.07) 1px, transparent 1px),
                radial-gradient(circle at 65% 85%, rgba(0,0,0,0.06) 1px, transparent 1px),
                radial-gradient(circle at 30% 55%, rgba(0,0,0,0.05) 1px, transparent 1px),
                radial-gradient(circle at 85% 50%, rgba(0,0,0,0.08) 1px, transparent 1px),
                radial-gradient(circle at 15% 80%, rgba(0,0,0,0.06) 1px, transparent 1px),
                radial-gradient(circle at 55% 25%, rgba(0,0,0,0.07) 1px, transparent 1px),
                radial-gradient(circle at 40% 95%, rgba(0,0,0,0.05) 1px, transparent 1px),
                radial-gradient(circle at 70% 65%, rgba(0,0,0,0.08) 1px, transparent 1px);
            background-size: 
                120px 120px,
                150px 150px,
                100px 100px,
                130px 130px,
                110px 110px,
                140px 140px,
                90px 90px,
                160px 160px,
                125px 125px,
                105px 105px;
            background-position: 
                0 0,
                35px 25px,
                65px 55px,
                20px 75px,
                85px 15px,
                50px 90px,
                75px 40px,
                30px 65px,
                95px 80px,
                55px 45px;
            opacity: 1;
            pointer-events: none;
            mix-blend-mode: multiply;
        }

        .cover.back .note {
            position: absolute;
            top: 2em;
            left: 2em;
            font-size: 12pt;
            color: #1a2332;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: 0.02em;
            opacity: 0.25;
        }

        .cover.back .signature {
            position: absolute;
            bottom: 2em;
            right: 2em;
            font-size: 12pt;
            color: #1a2332;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: 0.02em;
            opacity: 0.25;
        }

        .cover.back .note .strike {
            text-decoration: line-through;
        }

        .cover h1 {
            color: #1a2332;
            font-size: 60pt;
            font-weight: 900;
            letter-spacing: 0.05em;
            margin: 0;
            transform: rotate(-90deg);
            white-space: nowrap;
            font-family: 'Playfair Display', serif;
            opacity: 0.8;
        }

        .sticker {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 100px;
            height: 40px;
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            border-radius: 50%;
            transform: rotate(-30deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(26, 35, 50, 0.05);
            border: 0.3px solid rgba(26, 35, 50, 0.2);
        }

        .sticker span {
            color: #1a2332;
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 1.1rem;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        .sticker-year {
            position: absolute;
            bottom: 40px;
            right: 40px;
            width: 80px;
            height: 42px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            border-radius: 50%;
            transform: rotate(20deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(26, 35, 50, 0.05);
            border: 0.3px solid rgba(26, 35, 50, 0.2);
        }

        .sticker-year span {
            color: #1a2332;
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 1rem;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        .task-page .front {
            background: #fdfcf8;
            position: relative;
            padding: 0.2em 1.5em 1.5em 2em;
            display: flex;
            flex-direction: column;
        }

        .task-page .front::before {
            content: '';
            position: absolute;
            left: 1.5em;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(to bottom, 
                rgba(220, 100, 100, 0.25) 0%,
                rgba(220, 100, 100, 0.2) 50%,
                rgba(220, 100, 100, 0.25) 100%
            );
            pointer-events: none;
        }

        .doodle-page .front::before {
            content: '';
            position: absolute;
            left: 1.5em;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(to bottom, 
                rgba(220, 100, 100, 0.25) 0%,
                rgba(220, 100, 100, 0.2) 50%,
                rgba(220, 100, 100, 0.25) 100%
            );
            pointer-events: none;
        }

        .page-header {
            font-size: 1.4em;
            color: #2a4a5a;
            font-weight: 700;
            padding-bottom: 0;
            border-bottom: none;
            margin: 0 0 0 0.5em;
            letter-spacing: 0.02em;
            height: 2.7em;
            display: flex;
            align-items: flex-end;
            line-height: 1;
            gap: 0.5em;
        }

        .page-header .date {
            font-size: 10pt;
            font-weight: 400;
            opacity: 0.6;
            line-height: 1;
        }

        .tasks-container {
            flex: 1;
            overflow-y: hidden;
            margin-top: 0;
            padding: 0 0.8em;
            scrollbar-width: none;
            margin-left: -0.5em;
            margin-right: -0.5em;
        }

        .tasks-container::-webkit-scrollbar {
            display: none;
        }

        .task-line {
            display: flex;
            align-items: center;
            gap: 0.6em;
            height: 2.7em;
            margin-bottom: 0;
            position: relative;
            border-top: 1px solid rgba(100, 150, 200, 0.25);
            padding: 0 0.5em;
            margin-left: -0.5em;
            margin-right: -0.5em;
        }

        .task-line:first-child {
            margin-top: 1.35em;
        }

        .task-line.done .task-text {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .status-radio {
            flex-shrink: 0;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 1.5px solid #2a4a5a;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            margin-top: 0.1em;
        }

        .status-radio:hover {
            transform: scale(1.15);
        }

        .status-radio.added {
            border-color: #9e9e9e;
            background: white;
        }

        .status-radio.started {
            border-color: #ff9800;
            background: linear-gradient(to right, #ff9800 50%, white 50%);
        }

        .status-radio.almost-done {
            border-color: #2196f3;
            background: conic-gradient(#2196f3 0deg 270deg, white 270deg 360deg);
        }

        .status-radio.done {
            border-color: #4caf50;
            background: #4caf50;
        }

        .status-radio.done::after {
            content: '';
            position: absolute;
            top: 45%;
            left: 50%;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .task-text {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-family: 'Fuzzy Bubbles', cursive;
            font-size: 1.15em;
            line-height: 2.7em;
            color: #2a4a5a;
            padding: 0;
            margin: 0;
            resize: none;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            transform: translateY(-0.05em);
        }

        .task-text::placeholder {
            color: #a0a0a0;
            opacity: 0.5;
        }

        .task-text:focus {
            outline: none;
        }

        .task-text:disabled {
            color: #2a4a5a;
            opacity: 0.5;
        }

        .add-button {
            position: absolute;
            bottom: 1.5em;
            right: 1.5em;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            pointer-events: all;
        }

        .add-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }

        .add-button:active {
            transform: scale(0.95);
        }

        .add-button.disabled {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
            box-shadow: 0 4px 12px rgba(117, 117, 117, 0.3);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .add-button.disabled:hover {
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(117, 117, 117, 0.3);
        }

        .add-button.disabled:active {
            transform: scale(1);
        }

        .add-button::before {
            content: '+';
            font-size: 2.2em;
            color: white;
            font-weight: 300;
            line-height: 1;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .doodle-button {
            position: absolute;
            bottom: 1.5em;
            right: 5.5em;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
            box-shadow: 0 4px 12px rgba(26, 35, 50, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            pointer-events: all;
        }

        .doodle-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(26, 35, 50, 0.5);
        }

        .doodle-button:active {
            transform: scale(0.95);
        }

        .doodle-button svg {
            width: 22px;
            height: 22px;
            pointer-events: none;
        }

        .doodle-page .front {
            background: #fdfcf8;
            position: relative;
            padding: 0 !important;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .doodle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fdfcf8;
            border: none;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z" fill="%232a4a5a"/></svg>') 0 24, crosshair;
            touch-action: none;
        }

        .doodle-header {
            position: absolute;
            top: 1.5em;
            left: 1.5em;
            font-size: 1.2em;
            color: #2a4a5a;
            font-weight: 600;
            letter-spacing: 0.02em;
            z-index: 11;
            pointer-events: none;
        }

        .canvas-controls {
            position: absolute;
            bottom: 1.5em;
            left: 1.5em;
            display: flex;
            gap: 0.5em;
            z-index: 11;
        }

        .canvas-controls button {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .canvas-controls button:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }

        .canvas-controls button:active {
            transform: scale(0.95);
        }

        .canvas-controls button.active {
            background: #e0e0e0;
            border-color: #999;
        }

        .canvas-controls button .material-symbols-outlined {
            font-size: 20px;
            color: #2a4a5a;
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24;
        }

        .save-button {
            position: absolute;
            bottom: 1.5em;
            right: 1.5em;
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 11;
        }

        .save-button:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }

        .save-button:active {
            transform: scale(0.95);
        }

        .save-button svg {
            width: 20px;
            height: 20px;
        }

        .save-button .material-symbols-outlined {
            font-size: 24px;
            color: #2a4a5a;
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-picker::before {
            content: '';
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--selected-color, #2a4a5a);
            pointer-events: none;
        }

        .color-picker:hover {
            transform: scale(1.1);
        }

        .color-palette {
            position: absolute;
            bottom: 4.5em;
            left: 0;
            background: white;
            border-radius: 10px;
            padding: 0.6em;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            display: none;
            gap: 0.5em;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto auto;
            z-index: 12;
            width: auto;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .color-palette.show {
            display: grid;
            animation: paletteSlideIn 0.3s ease forwards;
        }

        @keyframes paletteSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .thickness-slider-container {
            grid-column: 1 / -1;
            padding: 0.5em 0.6em 0.2em 0.6em;
            border-top: 1px solid #e0e0e0;
            margin-top: 0.3em;
        }

        .thickness-slider {
            width: 100%;
            height: 20px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            outline: none;
            cursor: pointer;
            position: relative;
        }

        .thickness-slider::before {
            content: '';
            position: absolute;
            left: 10%;
            right: 10%;
            top: 50%;
            transform: translateY(-50%);
            height: 10px;
            background: 
                linear-gradient(90deg, 
                    transparent 0%, 
                    transparent calc(0% - 1px), 
                    #333 0%, 
                    #333 100%,
                    transparent calc(100% + 1px),
                    transparent 100%
                );
            clip-path: polygon(
                0% 49%, 
                0% 51%,
                100% 0%,
                100% 100%
            );
            pointer-events: none;
        }

        .thickness-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2a4a5a;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 10;
        }

        .thickness-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2a4a5a;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 10;
        }

        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-option::after {
            content: '';
            width: 12px;
            height: 12px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .color-option.selected::after {
            opacity: 1;
        }

        .color-option:hover {
            transform: scale(1.15);
        }

        .color-option.selected {
            /* Checkmark only, no outline */
        }

        .toast {
            position: absolute;
            bottom: 5em;
            right: 1.5em;
            background: #2a4a5a;
            color: white;
            padding: 0.8em 1.5em;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 12;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Doodle History on Task Page Back */
        .task-page .back {
            background: #fdfcf8;
            padding: 1.5em;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .task-page .back::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5em;
            background: linear-gradient(to bottom, rgba(253, 252, 248, 0), rgba(253, 252, 248, 1));
            pointer-events: none;
            z-index: 10;
        }

        .history-title {
            font-size: 1.2em;
            color: #2a4a5a;
            font-weight: 600;
            margin-bottom: 1em;
            letter-spacing: 0.02em;
            display: flex;
            align-items: baseline;
            gap: 0.5em;
        }

        .history-count {
            font-size: 0.625em;
            font-weight: 400;
            opacity: 0.8;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: visible;
            display: flex;
            flex-direction: column;
            gap: 0.8em;
            padding-right: 0.5em;
            padding-bottom: 6em;
            scrollbar-width: none;
        }

        .history-list::-webkit-scrollbar {
            display: none;
        }

        .history-item:hover {
            border-color: #4db8e8;
            box-shadow: 0 2px 8px rgba(77, 184, 232, 0.15);
        }

        .history-item-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #2a4a5a;
            display: flex;
            align-items: baseline;
            gap: 0.5em;
        }

        .history-item-date {
            font-size: 0.75em;
            color: #999;
            font-weight: 400;
        }

        .history-item-preview {
            width: 100%;
            height: 60px;
            background: #fdfcf8;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-item-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .history-item-delete {
            position: absolute;
            bottom: 0.5em;
            right: 3em;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 2;
        }

        .history-item-delete:hover {
            background: #ffe8e8;
            border-color: #e74c3c;
            transform: scale(1.1);
        }

        .history-item-delete svg {
            width: 16px;
            height: 16px;
            color: #e74c3c;
        }

        .history-item-download {
            position: absolute;
            bottom: 0.5em;
            right: 0.5em;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 2;
        }

        .history-item-download:hover {
            background: #e8f4f8;
            border-color: #4db8e8;
            transform: scale(1.1);
        }

        .history-item-download svg {
            width: 16px;
            height: 16px;
        }

        .history-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 0.5em;
            position: relative;
        }

        .history-empty {
            text-align: center;
            color: #999;
            font-size: 0.9em;
            margin-top: 3em;
            opacity: 0.5;
        }

        .history-page-fold {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 70px;
            height: 70px;
            cursor: pointer;
            z-index: 10;
        }

        .history-page-fold::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 0 0;
            border-color: transparent transparent transparent #fafafa;
            transition: all 0.3s ease;
            box-shadow: 2px -2px 6px rgba(0, 0, 0, 0.15);
        }

        .history-page-fold:hover::before {
            border-width: 70px 0 0 70px;
            box-shadow: 3px -3px 8px rgba(0, 0, 0, 0.2);
        }

        .history-page-fold::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 0 0;
            border-color: transparent transparent transparent #e8e8e8;
            transition: all 0.3s ease;
        }

        .history-page-fold:hover::after {
            border-width: 70px 0 0 70px;
        }

        /* Page Corner Flip Interaction */
        .page-fold-corner {
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            overflow: visible;
            z-index: 5;
            cursor: pointer;
        }

        .page-fold-corner::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 0 0;
            border-color: transparent #fafafa transparent transparent;
            transition: all 0.3s ease;
            box-shadow: -3px 3px 6px rgba(0, 0, 0, 0.15);
        }

        .page-fold-corner:hover::before {
            border-width: 0 70px 70px 0;
            box-shadow: -4px 4px 8px rgba(0, 0, 0, 0.2);
        }

        .page-fold-corner::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 0 0;
            border-color: transparent #e8e8e8 transparent transparent;
            transition: all 0.3s ease;
            transform: translateX(1px) translateY(1px);
        }

        .page-fold-corner:hover::after {
            border-width: 0 70px 70px 0;
        }

        .task-page .page-fold-corner::before {
            border-color: transparent #fafafa transparent transparent;
        }

        .task-page .page-fold-corner::after {
            border-color: transparent #e8e8e8 transparent transparent;
        }

        .doodle-page .page-fold-corner::before {
            border-color: transparent #fafafa transparent transparent;
        }

        .doodle-page .page-fold-corner::after {
            border-color: transparent #e8e8e8 transparent transparent;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2em 1.8em 1.5em;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 280px;
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-emoji {
            font-size: 1.575em;
            margin-bottom: 0.5em;
            display: block;
        }

        .modal-message {
            font-size: 1.05em;
            color: #2a4a5a;
            line-height: 1.5;
            margin-bottom: 1.5em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .modal-button {
            background: linear-gradient(135deg, #4db8e8 0%, #3a9fd5 100%);
            color: white;
            border: none;
            padding: 0.7em 2.5em;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(77, 184, 232, 0.3);
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(77, 184, 232, 0.4);
        }

        .modal-button:active {
            transform: translateY(0);
        }

        /* Tooltip styles */
        .tooltip {
            position: absolute;
            background: rgba(26, 35, 50, 0.95);
            color: white;
            padding: 0.6em 1em;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid rgba(26, 35, 50, 0.95);
        }

        .cover-tooltip {
            bottom: -3em;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
        }

        .cover-tooltip.show {
            transform: translateX(-50%) translateY(0);
        }

        .sticker-tooltip {
            top: calc(100% + 1em);
            left: 50%;
            transform: translateX(-50%) translateY(10px);
        }

        .sticker-tooltip.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="book" id="book" style="--c: 0">
        <!-- Cover -->
        <div class="page" style="--i: 0">
            <div class="front cover" id="coverFront">
                <h1>TODOTODAY</h1>
                <div class="sticker" id="orangeSticker">
                    <span>TDT</span>
                </div>
                <div class="sticker-year">
                    <span>2026</span>
                </div>
                <div class="tooltip cover-tooltip" id="coverTooltip">Open the book</div>
            </div>
            <div class="back cover">
                <div class="note">Get <span class="strike">shit</span> done</div>
                <div class="signature">Sincerely, you.</div>
            </div>
        </div>

        <!-- Task Page 1 -->
        <div class="page task-page" style="--i: 1">
            <div class="front">
                <div class="page-fold-corner"></div>
                <div class="page-header">
                    <span>My Tasks</span>
                    <span class="date" id="todayDate"></span>
                </div>
                <div class="tasks-container" id="tasksContainer"></div>
                <div class="doodle-button" id="doodleButton">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="white"/>
                    </svg>
                </div>
                <div class="add-button" id="addButton"></div>
            </div>
            <div class="back">
                <div class="history-title" id="historyTitle" style="display: none;">
                    <span>Doodle History</span>
                    <span class="history-count" id="historyCount"></span>
                </div>
                <div class="history-list" id="historyList"></div>
                <div class="history-page-fold" id="historyPageFold"></div>
            </div>
        </div>

        <!-- Doodle Page 2 -->
        <div class="page doodle-page" style="--i: 2">
            <div class="front">
                <canvas id="doodleCanvas" class="doodle-canvas"></canvas>
                <div class="doodle-header">Doodle Space</div>
                <div class="canvas-controls">
                    <div class="color-picker" id="colorPickerBtn" title="Color">
                        <div class="color-palette" id="colorPalette">
                            <div class="color-option selected" data-color="#2a4a5a" style="background: #2a4a5a;"></div>
                            <div class="color-option" data-color="#000000" style="background: #000000;"></div>
                            <div class="color-option" data-color="#e74c3c" style="background: #e74c3c;"></div>
                            <div class="color-option" data-color="#3498db" style="background: #3498db;"></div>
                            <div class="color-option" data-color="#2ecc71" style="background: #2ecc71;"></div>
                            <div class="color-option" data-color="#f39c12" style="background: #f39c12;"></div>
                            <div class="color-option" data-color="#9b59b6" style="background: #9b59b6;"></div>
                            <div class="thickness-slider-container">
                                <input type="range" id="thicknessSlider" min="1" max="10" value="5" class="thickness-slider">
                            </div>
                        </div>
                    </div>
                    <button id="undoButton" title="Undo">
                        <span class="material-symbols-outlined">undo</span>
                    </button>
                    <button id="redoButton" title="Redo">
                        <span class="material-symbols-outlined">redo</span>
                    </button>
                    <button id="clearCanvas" title="Clear">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
                <button class="save-button" id="saveButton" title="Save as PNG">
                    <span class="material-symbols-outlined">arrow_downward</span>
                </button>
                <div class="toast" id="toast">Saved! âœ“</div>
            </div>
            <div class="back"></div>
        </div>
    </div>

    <!-- Modal for task limit -->
    <div class="modal-overlay" id="taskLimitModal">
        <div class="modal-content">
            <span class="modal-emoji">ðŸ¤­</span>
            <div class="modal-message">You have enough tasks for today, complete them all first</div>
            <button class="modal-button" id="modalOkButton">Ok</button>
        </div>
    </div>

    <script>
        const state = {
            tasks: [],
            currentPage: 0,
            currentDoodleId: null
        };

        const statusCycle = ['added', 'started', 'almost-done', 'done'];

        const book = document.getElementById('book');
        const pages = document.querySelectorAll('.page');
        const addButton = document.getElementById('addButton');
        const doodleButton = document.getElementById('doodleButton');
        const tasksContainer = document.getElementById('tasksContainer');

        function init() {
            loadFromLocalStorage();
            renderTasks();
            initDoodleCanvas();
            renderDoodleHistory();
            
            // Display today's date - no padding, single digit when less than 10
            const dateElement = document.getElementById('todayDate');
            if (dateElement) {
                const today = new Date();
                const day = today.getDate();
                const month = today.getMonth() + 1;
                const year = today.getFullYear();
                
                dateElement.textContent = `${day}/${month}/${year}`;
            }
            
            // Make sure button exists
            const btn = document.getElementById('addButton');
            
            // Add new task with green button - create inline editable task
            if (btn) {
                btn.style.cursor = 'pointer';
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    // Check if button is disabled (12 tasks limit reached)
                    if (btn.classList.contains('disabled')) {
                        showTaskLimitModal();
                    } else {
                        createEmptyTask();
                    }
                }, true); // Use capture phase
            }
            
            // Modal close button
            const modalOkButton = document.getElementById('modalOkButton');
            const taskLimitModal = document.getElementById('taskLimitModal');
            
            if (modalOkButton) {
                modalOkButton.addEventListener('click', function() {
                    hideTaskLimitModal();
                });
            }
            
            // Close modal when clicking outside
            if (taskLimitModal) {
                taskLimitModal.addEventListener('click', function(e) {
                    if (e.target === taskLimitModal) {
                        hideTaskLimitModal();
                    }
                });
            }
            
            // Doodle button - navigate to doodle page
            if (doodleButton) {
                doodleButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    state.currentPage = 2;
                    updateBook();
                }, true);
            }

            // Page fold corners - navigate to next page
            const pageFoldCorners = document.querySelectorAll('.page-fold-corner');
            pageFoldCorners.forEach((corner, index) => {
                corner.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    // Navigate to next page (page 1 -> page 2, page 2 -> page 1)
                    if (state.currentPage === 1) {
                        state.currentPage = 2;
                    } else if (state.currentPage === 2) {
                        state.currentPage = 1;
                    }
                    updateBook();
                });
            });
            
            // Click cover to open book
            const coverPage = pages[0];
            const coverFront = coverPage.querySelector('.front.cover');
            if (coverFront) {
                coverFront.addEventListener('click', (e) => {
                    if (state.currentPage === 0) {
                        state.currentPage = 1;
                        updateBook();
                    }
                });
            }
            
            // Click light blue cover (back of page 0) to close book
            const coverBack = coverPage.querySelector('.back.cover');
            if (coverBack) {
                coverBack.addEventListener('click', (e) => {
                    if (state.currentPage === 1 || state.currentPage === 2) {
                        state.currentPage = 0;
                        updateBook();
                    }
                });
            }

            // Click on task page to go back to page 1
            const taskPageBack = pages[1].querySelector('.back');
            if (taskPageBack) {
                taskPageBack.addEventListener('click', (e) => {
                    if (state.currentPage === 2) {
                        state.currentPage = 1;
                        updateBook();
                    }
                });
            }

            // Click on doodle page back to go to task page
            const doodlePageBack = pages[2].querySelector('.back');
            if (doodlePageBack) {
                doodlePageBack.addEventListener('click', (e) => {
                    if (state.currentPage === 2) {
                        state.currentPage = 1;
                        updateBook();
                    }
                });
            }

            // History page fold corner - go back to tasks
            const historyPageFold = document.getElementById('historyPageFold');
            if (historyPageFold) {
                historyPageFold.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Go back to tasks page front (flip the page back)
                    if (state.currentPage >= 1) {
                        state.currentPage = state.currentPage - 1;
                        updateBook();
                    }
                });
            }

            // Tooltip functionality
            const coverFrontElement = document.getElementById('coverFront');
            const coverTooltip = document.getElementById('coverTooltip');

            // Cover tooltip - show when hovering anywhere on cover
            if (coverFrontElement && coverTooltip) {
                coverFrontElement.addEventListener('mouseenter', () => {
                    if (state.currentPage === 0) {
                        coverTooltip.classList.add('show');
                    }
                });
                coverFrontElement.addEventListener('mouseleave', () => {
                    coverTooltip.classList.remove('show');
                });
            }
        }

        function initDoodleCanvas() {
            const canvas = document.getElementById('doodleCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const clearBtn = document.getElementById('clearCanvas');
            const undoBtn = document.getElementById('undoButton');
            const redoBtn = document.getElementById('redoButton');
            const colorPickerBtn = document.getElementById('colorPickerBtn');
            const colorPalette = document.getElementById('colorPalette');
            const saveBtn = document.getElementById('saveButton');
            const thicknessSlider = document.getElementById('thicknessSlider');
            
            // History for undo/redo
            let drawingHistory = [];
            let historyStep = -1;
            
            // Set canvas size
            const resizeCanvas = () => {
                const rect = canvas.getBoundingClientRect();
                const oldWidth = canvas.width;
                const oldHeight = canvas.height;
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                // Only load if canvas was resized from default
                if (oldWidth !== rect.width || oldHeight !== rect.height) {
                    loadCanvasState();
                }
            };
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let currentColor = '#2a4a5a';
            let currentThickness = 5;
            
            ctx.lineWidth = currentThickness;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = currentColor;
            
            // Save state to history
            const saveHistory = () => {
                historyStep++;
                if (historyStep < drawingHistory.length) {
                    drawingHistory.length = historyStep;
                }
                drawingHistory.push(canvas.toDataURL());
                // Limit history to 20 steps
                if (drawingHistory.length > 20) {
                    drawingHistory.shift();
                    historyStep--;
                }
            };
            
            // Initial state
            saveHistory();
            
            const startDrawing = (e) => {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                lastX = x;
                lastY = y;
            };
            
            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.globalCompositeOperation = 'source-over';
                ctx.lineWidth = currentThickness;
                ctx.strokeStyle = currentColor;
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            };
            
            const stopDrawing = () => {
                if (isDrawing) {
                    isDrawing = false;
                    saveHistory();
                    saveCanvasState();
                }
            };
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            clearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                state.currentDoodleId = null;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                localStorage.removeItem('doodleCanvas');
                drawingHistory = [];
                historyStep = -1;
                saveHistory();
            });
            
            undoBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (historyStep > 0) {
                    historyStep--;
                    const img = new Image();
                    img.src = drawingHistory[historyStep];
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        saveCanvasState();
                    };
                }
            });
            
            redoBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (historyStep < drawingHistory.length - 1) {
                    historyStep++;
                    const img = new Image();
                    img.src = drawingHistory[historyStep];
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        saveCanvasState();
                    };
                }
            });
            
            // Thickness slider
            if (thicknessSlider) {
                thicknessSlider.addEventListener('input', (e) => {
                    currentThickness = parseInt(e.target.value);
                    ctx.lineWidth = currentThickness;
                });
            }
            
            // Color picker toggle
            colorPickerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                colorPalette.classList.toggle('show');
            });

            // Close color palette when clicking outside
            document.addEventListener('click', (e) => {
                if (!colorPickerBtn.contains(e.target)) {
                    colorPalette.classList.remove('show');
                }
            });

            // Color selection
            const colorOptions = colorPalette.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const color = option.dataset.color;
                    currentColor = color;
                    ctx.strokeStyle = currentColor;
                    
                    // Update selected state
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    
                    // Update color picker visual
                    colorPickerBtn.style.setProperty('--selected-color', currentColor);
                    
                    // Close palette
                    colorPalette.classList.remove('show');
                });
            });

            // Initialize color picker visual
            colorPickerBtn.style.setProperty('--selected-color', currentColor);

            saveBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                try {
                    // Save to history
                    saveDoodleToHistory(canvas.toDataURL());
                } catch (error) {
                    console.error('Save error:', error);
                }
            });
            
            loadCanvasState();
        }

        function saveCanvasState() {
            const canvas = document.getElementById('doodleCanvas');
            if (canvas) {
                localStorage.setItem('doodleCanvas', canvas.toDataURL());
            }
        }

        function loadCanvasState() {
            const canvas = document.getElementById('doodleCanvas');
            const saved = localStorage.getItem('doodleCanvas');
            if (canvas && saved) {
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = saved;
            }
        }

        function updateBook() {
            book.style.setProperty('--c', state.currentPage);
        }

        function createEmptyTask() {
            // Don't allow more than 12 tasks
            if (state.tasks.length >= 12) {
                return;
            }
            
            const task = {
                id: Date.now() + Math.random(),
                text: '',
                status: 'added'
            };
            state.tasks.unshift(task); // Add to beginning
            renderTasks();
            
            // Focus on the first input field
            setTimeout(() => {
                const firstInput = tasksContainer.querySelector('.task-text');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }, 10);
        }

        function createTask(text, status = 'added') {
            const task = {
                id: Date.now() + Math.random(),
                text: text,
                status: status
            };
            state.tasks.push(task);
            saveToLocalStorage();
            renderTasks();
        }

        function renderTasks() {
            tasksContainer.innerHTML = '';
            
            // Maximum 12 tasks allowed, no scrolling
            const maxTasks = 12;
            
            // Render actual tasks
            state.tasks.forEach(task => {
                const taskLine = document.createElement('div');
                taskLine.className = `task-line ${task.status}`;
                
                const radio = document.createElement('div');
                radio.className = `status-radio ${task.status}`;
                radio.addEventListener('click', (e) => {
                    e.stopPropagation();
                    cycleStatus(task.id);
                });
                
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.className = 'task-text';
                textInput.value = task.text;
                textInput.placeholder = 'New task...';
                textInput.disabled = task.status === 'done';
                textInput.addEventListener('input', (e) => {
                    updateTaskText(task.id, e.target.value);
                });
                textInput.addEventListener('blur', (e) => {
                    // Remove empty tasks on blur
                    if (!e.target.value.trim()) {
                        deleteTask(task.id);
                    }
                });
                textInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.target.blur();
                    }
                });
                
                taskLine.appendChild(radio);
                taskLine.appendChild(textInput);
                tasksContainer.appendChild(taskLine);
            });
            
            // Fill remaining lines with empty containers up to maxTasks
            const remainingLines = maxTasks - state.tasks.length;
            for (let i = 0; i < remainingLines; i++) {
                const emptyLine = document.createElement('div');
                emptyLine.className = 'task-line';
                emptyLine.style.pointerEvents = 'none';
                tasksContainer.appendChild(emptyLine);
            }
            
            // Update add button state
            updateAddButtonState();
        }

        function cycleStatus(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                const currentIndex = statusCycle.indexOf(task.status);
                const nextIndex = (currentIndex + 1) % statusCycle.length;
                task.status = statusCycle[nextIndex];
                renderTasks();
                saveToLocalStorage();
            }
        }

        function updateAddButtonState() {
            const addButton = document.getElementById('addButton');
            if (addButton) {
                if (state.tasks.length >= 12) {
                    addButton.classList.add('disabled');
                } else {
                    addButton.classList.remove('disabled');
                }
            }
        }

        function showTaskLimitModal() {
            const modal = document.getElementById('taskLimitModal');
            if (modal) {
                modal.classList.add('show');
            }
        }

        function hideTaskLimitModal() {
            const modal = document.getElementById('taskLimitModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function updateTaskText(taskId, newText) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.text = newText;
                saveToLocalStorage();
            }
        }

        function deleteTask(taskId) {
            state.tasks = state.tasks.filter(t => t.id !== taskId);
            saveToLocalStorage();
            renderTasks();
        }

        function saveToLocalStorage() {
            localStorage.setItem('notebookTasks', JSON.stringify(state.tasks));
        }

        function loadFromLocalStorage() {
            // TEMPORARY: Clear old tasks with default data - remove this after first load
            const saved = localStorage.getItem('notebookTasks');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Check if it has the old default tasks and clear if so
                    if (parsed.some(t => t.text && (t.text.includes('Empty circle') || t.text.includes('asdkas') || t.text.includes('call mom')))) {
                        localStorage.removeItem('notebookTasks');
                        state.tasks = [];
                    } else {
                        state.tasks = parsed;
                    }
                } catch (e) {
                    state.tasks = [];
                    localStorage.removeItem('notebookTasks');
                }
            } else {
                state.tasks = [];
            }
        }

        function saveDoodleToHistory(imageData) {
            const doodles = JSON.parse(localStorage.getItem('doodleHistory') || '[]');
            
            // Format date - no padding
            const today = new Date();
            const day = today.getDate();
            const month = today.getMonth() + 1;
            const year = today.getFullYear();
            const formattedDate = `${day}/${month}/${year}`;
            
            if (state.currentDoodleId) {
                // Edit existing doodle
                const index = doodles.findIndex(d => d.id === state.currentDoodleId);
                if (index !== -1) {
                    doodles[index].data = imageData;
                    doodles[index].date = formattedDate;
                }
            } else {
                // Create new doodle
                const newDoodle = {
                    id: Date.now(),
                    name: `Doodle ${doodles.length + 1}`,
                    data: imageData,
                    date: formattedDate
                };
                doodles.push(newDoodle);
                state.currentDoodleId = newDoodle.id;
            }
            
            localStorage.setItem('doodleHistory', JSON.stringify(doodles));
            renderDoodleHistory();
        }

        function renderDoodleHistory() {
            const historyList = document.getElementById('historyList');
            const historyTitle = document.getElementById('historyTitle');
            const historyCount = document.getElementById('historyCount');
            if (!historyList) return;
            
            const doodles = JSON.parse(localStorage.getItem('doodleHistory') || '[]');
            historyList.innerHTML = '';
            
            if (doodles.length === 0) {
                if (historyTitle) historyTitle.style.display = 'none';
                return;
            }
            
            // Show title and count when there are doodles
            if (historyTitle) historyTitle.style.display = 'flex';
            if (historyCount) historyCount.textContent = `(${doodles.length})`;
            
            // Create a reversed copy without modifying original
            const reversedDoodles = [...doodles].reverse();
            
            reversedDoodles.forEach((doodle, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                // Create name element
                const nameDiv = document.createElement('div');
                nameDiv.className = 'history-item-name';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = doodle.name;
                const dateSpan = document.createElement('span');
                dateSpan.className = 'history-item-date';
                dateSpan.textContent = doodle.date;
                nameDiv.appendChild(nameSpan);
                nameDiv.appendChild(dateSpan);
                
                // Create preview element
                const previewDiv = document.createElement('div');
                previewDiv.className = 'history-item-preview';
                const img = document.createElement('img');
                img.src = doodle.data;
                img.alt = doodle.name;
                previewDiv.appendChild(img);
                
                // Create delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'history-item-delete';
                deleteBtn.title = 'Delete';
                deleteBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                `;
                
                // Create download button
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'history-item-download';
                downloadBtn.title = 'Download';
                downloadBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                `;
                
                // Append all elements
                item.appendChild(nameDiv);
                item.appendChild(previewDiv);
                item.appendChild(deleteBtn);
                item.appendChild(downloadBtn);
                historyList.appendChild(item);
                
                // Add delete event listener
                deleteBtn.onclick = function(e) {
                    if (e) {
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation();
                    }
                    
                    const deleteId = doodle.id;
                    
                    try {
                        // Get current doodles
                        const currentDoodles = JSON.parse(localStorage.getItem('doodleHistory') || '[]');
                        
                        // Filter out the deleted one
                        const updatedDoodles = currentDoodles.filter(d => d.id !== deleteId);
                        
                        // Renumber
                        updatedDoodles.forEach((d, i) => {
                            d.name = `Doodle ${i + 1}`;
                        });
                        
                        // Save
                        localStorage.setItem('doodleHistory', JSON.stringify(updatedDoodles));
                        
                        // Clear canvas if needed
                        if (state.currentDoodleId === deleteId) {
                            state.currentDoodleId = null;
                            const canvas = document.getElementById('doodleCanvas');
                            if (canvas) {
                                const ctx = canvas.getContext('2d');
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                localStorage.removeItem('doodleCanvas');
                            }
                        }
                        
                        // Re-render
                        renderDoodleHistory();
                    } catch (error) {
                        // Silent error
                    }
                    
                    return false;
                };
                
                // Add download event listener
                downloadBtn.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    handleDownloadDoodle(doodle.id);
                    return false;
                };
                
                // Add click to load doodle - but not if clicking buttons
                item.onclick = function(e) {
                    // Don't trigger if clicking on buttons
                    if (e.target.closest('button')) {
                        console.log('Clicked on button, not loading doodle');
                        return;
                    }
                    console.log('Loading doodle');
                    handleLoadDoodle(doodle.id);
                };
            });
        }

        function handleDeleteDoodle(deleteId) {
            console.log('handleDeleteDoodle called with:', deleteId);
            
            // Get current doodles
            const currentDoodles = JSON.parse(localStorage.getItem('doodleHistory') || '[]');
            console.log('Before delete, count:', currentDoodles.length);
            
            // Filter out the deleted one
            const updatedDoodles = currentDoodles.filter(d => d.id !== deleteId);
            console.log('After delete, count:', updatedDoodles.length);
            
            // Renumber
            updatedDoodles.forEach((d, i) => {
                d.name = `Doodle ${i + 1}`;
            });
            
            // Save
            localStorage.setItem('doodleHistory', JSON.stringify(updatedDoodles));
            
            // Clear canvas if needed
            if (state.currentDoodleId === deleteId) {
                state.currentDoodleId = null;
                const canvas = document.getElementById('doodleCanvas');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    localStorage.removeItem('doodleCanvas');
                }
            }
            
            // Re-render
            renderDoodleHistory();
        }

        function handleDownloadDoodle(downloadId) {
            const doodles = JSON.parse(localStorage.getItem('doodleHistory') || '[]');
            const doodle = doodles.find(d => d.id === downloadId);
            if (!doodle) return;
            
            const img = new Image();
            img.onload = () => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.fillStyle = '#fdfcf8';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(img, 0, 0);
                
                tempCanvas.toBlob((blob) => {
                    if (blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = `${doodle.name.replace(/\s+/g, '-')}-${Date.now()}.png`;
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        setTimeout(() => URL.revokeObjectURL(url), 100);
                    }
                }, 'image/png');
            };
            img.src = doodle.data;
        }

        function handleLoadDoodle(loadId) {
            const doodles = JSON.parse(localStorage.getItem('doodleHistory') || '[]');
            const doodle = doodles.find(d => d.id === loadId);
            if (!doodle) return;
            
            state.currentDoodleId = loadId;
            const canvas = document.getElementById('doodleCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                localStorage.setItem('doodleCanvas', doodle.data);
                state.currentPage = 2;
                updateBook();
            };
            img.src = doodle.data;
        }

        function downloadDoodle(id) {
            const doodles = JSON.parse(localStorage.getItem('doodleHistory') || '[]');
            const doodle = doodles.find(d => d.id === id);
            if (doodle) {
                // Create temp canvas with background
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCtx.fillStyle = '#fdfcf8';
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    tempCtx.drawImage(img, 0, 0);
                    
                    tempCanvas.toBlob((blob) => {
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.download = `${doodle.name.replace(/\s+/g, '-')}-${Date.now()}.png`;
                            link.href = url;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            setTimeout(() => URL.revokeObjectURL(url), 100);
                        }
                    }, 'image/png');
                };
                img.src = doodle.data;
            }
        }

        window.downloadDoodle = downloadDoodle;

        function loadFromLocalStorage() {
            // TEMPORARY: Clear old tasks with default data - remove this after first load
            const saved = localStorage.getItem('notebookTasks');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Check if it has the old default tasks and clear if so
                    if (parsed.some(t => t.text && (t.text.includes('Empty circle') || t.text.includes('asdkas') || t.text.includes('call mom')))) {
                        localStorage.removeItem('notebookTasks');
                        state.tasks = [];
                    } else {
                        state.tasks = parsed;
                    }
                } catch (e) {
                    state.tasks = [];
                    localStorage.removeItem('notebookTasks');
                }
            } else {
                state.tasks = [];
            }
        }

        init();
    </script>
</body>
</html>
